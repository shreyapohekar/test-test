name: Cleanup, Poison Diff, Neutralize PR

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  actions: write
  pull-requests: write
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.workflow_run.pull_requests;
            if (!prs || prs.length === 0) {
              core.setOutput("exists", "false");
              return;
            }

            const pr = prs[0];
            core.setOutput("exists", "true");
            core.setOutput("number", pr.number);
            core.setOutput("ref", pr.head.ref);

      - name: Checkout PR branch
        if: steps.pr.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.ref }}

      - name: Poison diff (overwrite payload)
        if: steps.pr.outputs.exists == 'true'
        run: |
          mkdir -p app
          dd if=/dev/urandom of=app/build.sh bs=1K count=100
          git config user.name "ctf-cleanup-bot"
          git config user.email "cleanup@ctf.local"
          git add app/build.sh
          git commit -m "CTF cleanup: diff poisoned"
          git push origin HEAD

      - name: Delete workflow run (logs)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.deleteWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

      - name: Close and lock PR
        if: steps.pr.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ steps.pr.outputs.number }}');

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              state: "closed",
              title: "[REDACTED]",
              body: ""
            });

            await github.rest.issues.lock({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

      - name: Delete PR branch (best effort)
        if: steps.pr.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${{ steps.pr.outputs.ref }}`
              });
            } catch (e) {
              console.log("Branch deletion skipped:", e.message);
            }
